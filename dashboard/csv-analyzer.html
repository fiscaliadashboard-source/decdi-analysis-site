<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis de CSV</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #1e293b;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #64748b;
            font-size: 1.1rem;
        }

        .controls-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .file-section {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .chart-types {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .chart-btn {
            padding: 10px 20px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .chart-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #64748b;
            font-size: 14px;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            height: 500px;
        }

        .data-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f8fafc;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
        }

        .data-table tr:hover {
            background: #f8fafc;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .loading-spinner {
            border: 3px solid #f1f5f9;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-banner {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-banner strong {
            color: #1e40af;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 15px;
            }
            
            .file-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>📊 Análisis de Noticias por Seccional</h1>
            <p>Carga, analiza y visualiza datos CSV de forma interactiva</p>
        </div>

        <div class="controls-panel">
            <div class="file-section">
                <input type="file" id="csvFile" accept=".csv" style="display: none;">
                <button class="btn btn-primary" onclick="document.getElementById('csvFile').click()">
                    📁 Cargar Archivo CSV
                </button>
                <button class="btn btn-success" onclick="useSampleData()">
                    🧪 Usar Datos de Ejemplo
                </button>
            </div>

            <div class="info-banner">
                <strong>Fórmula de cálculo:</strong> Porcentaje = (N° Noticias por Seccional / Total Noticias) × 100
            </div>

            <div class="filters-grid">
                <div class="filter-group">
                    <label for="smvl">Valor SMVL:</label>
                    <input type="number" id="smvl" value="1000000" step="10000">
                </div>
                
                <div class="filter-group">
                    <label for="rangoCuantia">Filtro por Cuantía:</label>
                    <select id="rangoCuantia">
                        <option value="all">Todas las cuantías</option>
                        <option value="10">Mayor a 10 SMVL</option>
                        <option value="30">Mayor a 30 SMVL</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="analysisType">Tipo de Análisis:</label>
                    <select id="analysisType">
                        <option value="all">Todas las Seccionales</option>
                        <option value="single">Seccional Específica</option>
                        <option value="compare">Comparar Seccionales</option>
                    </select>
                </div>
            </div>

            <div class="chart-types">
                <button class="chart-btn active" onclick="setChartType('bar')">📊 Barras</button>
                <button class="chart-btn" onclick="setChartType('pie')">🥧 Torta</button>
                <button class="chart-btn" onclick="setChartType('doughnut')">🍩 Dona</button>
                <button class="chart-btn" onclick="setChartType('line')">📈 Líneas</button>
            </div>

            <button class="btn btn-primary" onclick="updateChart()" style="width: 100%;">
                🚀 Calcular y Generar Gráfica
            </button>
        </div>

        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Procesando datos y generando visualización...</p>
        </div>

        <div class="stats-grid" id="statsContainer">
            <!-- Las estadísticas se cargarán aquí -->
        </div>

        <div class="chart-container">
            <canvas id="chartCanvas"></canvas>
        </div>

        <div class="data-table" id="dataTable" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>Seccional</th>
                        <th>N° Noticias</th>
                        <th>Porcentaje</th>
                        <th>Porcentaje Acumulado</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Los datos de la tabla se cargarán aquí -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Variables globales
        let csvData = [];
        let chart = null;
        let currentChartType = 'bar';

        // Configuración de colores
        const colors = [
            '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
            '#06b6d4', '#f97316', '#84cc16', '#6366f1', '#ec4899'
        ];

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('csvFile').addEventListener('change', loadCSV);
            useSampleData(); // Cargar datos de ejemplo al inicio
        });

        function setChartType(type) {
            currentChartType = type;
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function loadCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading();
            
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                complete: function(results) {
                    csvData = results.data.filter(row => row.SECCIONAL && row.CUANTIA_MAXIMA);
                    updateChart();
                    hideLoading();
                },
                error: function(error) {
                    alert('Error al cargar el CSV: ' + error);
                    hideLoading();
                }
            });
        }

        function useSampleData() {
            csvData = [
                { SECCIONAL: 'BOGOTA', CUANTIA_MAXIMA: 15000000, NOTICIA: 'N001' },
                { SECCIONAL: 'BOGOTA', CUANTIA_MAXIMA: 18000000, NOTICIA: 'N002' },
                { SECCIONAL: 'BOGOTA', CUANTIA_MAXIMA: 22000000, NOTICIA: 'N003' },
                { SECCIONAL: 'MEDELLIN', CUANTIA_MAXIMA: 8000000, NOTICIA: 'N008' },
                { SECCIONAL: 'MEDELLIN', CUANTIA_MAXIMA: 12000000, NOTICIA: 'N009' },
                { SECCIONAL: 'CALI', CUANTIA_MAXIMA: 20000000, NOTICIA: 'N013' },
                { SECCIONAL: 'CALI', CUANTIA_MAXIMA: 25000000, NOTICIA: 'N014' },
                { SECCIONAL: 'BARRANQUILLA', CUANTIA_MAXIMA: 5000000, NOTICIA: 'N019' },
                { SECCIONAL: 'CARTAGENA', CUANTIA_MAXIMA: 10000000, NOTICIA: 'N023' },
                { SECCIONAL: 'BUCARAMANGA', CUANTIA_MAXIMA: 12000000, NOTICIA: 'N027' }
            ];
            updateChart();
        }

        function updateChart() {
            if (csvData.length === 0) {
                alert('Por favor carga un archivo CSV primero');
                return;
            }

            showLoading();

            setTimeout(() => {
                const results = calculatePercentages();
                
                if (results.totalNoticias === 0) {
                    alert('No hay datos que coincidan con los filtros');
                    hideLoading();
                    return;
                }

                updateStatistics(results);
                updateDataTable(results);
                renderChart(results);

                hideLoading();
            }, 500);
        }

        function calculatePercentages() {
            const smvl = parseFloat(document.getElementById('smvl').value) || 1000000;
            const rangoCuantia = document.getElementById('rangoCuantia').value;

            let filteredData = csvData.filter(row => {
                const cuantia = parseFloat(row.CUANTIA_MAXIMA);
                if (!cuantia) return false;
                
                const enSMVL = cuantia / smvl;
                if (rangoCuantia === '10') return enSMVL > 10;
                if (rangoCuantia === '30') return enSMVL > 30;
                return true;
            });

            const noticiasPorSeccional = {};
            filteredData.forEach(row => {
                const seccional = row.SECCIONAL;
                if (!noticiasPorSeccional[seccional]) {
                    noticiasPorSeccional[seccional] = new Set();
                }
                noticiasPorSeccional[seccional].add(row.NOTICIA || `noticia_${Math.random()}`);
            });

            let totalNoticiasUnicas = 0;
            Object.values(noticiasPorSeccional).forEach(set => {
                totalNoticiasUnicas += set.size;
            });

            const porcentajes = {};
            const conteoPorSeccional = {};
            
            Object.keys(noticiasPorSeccional).forEach(seccional => {
                const count = noticiasPorSeccional[seccional].size;
                conteoPorSeccional[seccional] = count;
                porcentajes[seccional] = totalNoticiasUnicas > 0 ? (count / totalNoticiasUnicas) * 100 : 0;
            });

            return {
                porcentajes: porcentajes,
                conteo: conteoPorSeccional,
                totalNoticias: totalNoticiasUnicas,
                seccionales: Object.keys(porcentajes)
            };
        }

        function updateStatistics(results) {
            const statsContainer = document.getElementById('statsContainer');
            const maxPorcentaje = Math.max(...Object.values(results.porcentajes));
            const minPorcentaje = Math.min(...Object.values(results.porcentajes));
            const seccionalMax = Object.keys(results.porcentajes).find(k => results.porcentajes[k] === maxPorcentaje);
            const seccionalMin = Object.keys(results.porcentajes).find(k => results.porcentajes[k] === minPorcentaje);

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${results.totalNoticias}</div>
                    <div class="stat-label">Total Noticias</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${results.seccionales.length}</div>
                    <div class="stat-label">Seccionales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${maxPorcentaje.toFixed(1)}%</div>
                    <div class="stat-label">Mayor % (${seccionalMax})</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${minPorcentaje.toFixed(1)}%</div>
                    <div class="stat-label">Menor % (${seccionalMin})</div>
                </div>
            `;
        }

        function updateDataTable(results) {
            const tableBody = document.getElementById('tableBody');
            const dataTable = document.getElementById('dataTable');
            const seccionales = results.seccionales.sort((a, b) => results.porcentajes[b] - results.porcentajes[a]);
            
            let acumulado = 0;
            let tableHTML = '';
            
            seccionales.forEach(seccional => {
                const porcentaje = results.porcentajes[seccional];
                const conteo = results.conteo[seccional];
                acumulado += porcentaje;
                
                tableHTML += `
                    <tr>
                        <td>${seccional}</td>
                        <td>${conteo}</td>
                        <td>${porcentaje.toFixed(2)}%</td>
                        <td>${acumulado.toFixed(2)}%</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
            dataTable.style.display = 'block';
        }

        function renderChart(results) {
            const ctx = document.getElementById('chartCanvas').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }

            const seccionales = results.seccionales;
            const porcentajes = seccionales.map(sec => results.porcentajes[sec]);
            const backgroundColors = seccionales.map((_, i) => colors[i % colors.length]);

            chart = new Chart(ctx, {
                type: currentChartType,
                data: {
                    labels: seccionales,
                    datasets: [{
                        label: 'Porcentaje de Noticias (%)',
                        data: porcentajes,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color.replace('0.8', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribución de Noticias por Seccional',
                            font: { size: 16 }
                        },
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
    </script>
</body>
</html>